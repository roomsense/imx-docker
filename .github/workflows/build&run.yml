name: Build i.MX Yocto in Docker

on:
  workflow_dispatch:
    inputs:
      ubuntu_version:
        description: 'Ubuntu Dockerfile version'
        required: true
        default: 'Dockerfile-Ubuntu-22.04'
        type: choice
        options:
          - 'Dockerfile-Ubuntu-20.04'
          - 'Dockerfile-Ubuntu-22.04'
          - 'Dockerfile-Ubuntu-24.04'
      imx_release:
        description: 'IMX release to build'
        required: true
        default: 'imx-6.1.22-2.0.0'

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      ubuntu_version: ${{ steps.validate.outputs.ubuntu_version }}
      imx_release: ${{ steps.validate.outputs.imx_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Debug repository structure
        run: |
          echo "=== Repository Structure ==="
          ls -la
          echo "=== Input Values ==="
          echo "Ubuntu version: '${{ github.event.inputs.ubuntu_version }}'"
          echo "IMX release: '${{ github.event.inputs.imx_release }}'"
          
      - name: Validate inputs
        id: validate
        run: |
          echo "üîç Starting validation..."
          VALIDATION_FAILED=false
          
          # Check Ubuntu Dockerfile
          if [ ! -f "${{ github.event.inputs.ubuntu_version }}" ]; then
            echo "‚ùå Error: Dockerfile ${{ github.event.inputs.ubuntu_version }} not found"
            echo "Available Dockerfiles:"
            ls -la Dockerfile* 2>/dev/null || echo "No Dockerfiles found"
            VALIDATION_FAILED=true
          else
            echo "‚úÖ Found Dockerfile: ${{ github.event.inputs.ubuntu_version }}"
          fi
          
          # Final validation check
          if [ "$VALIDATION_FAILED" = "true" ]; then
            echo "üí• Validation failed - stopping workflow"
            exit 1
          fi
          
          # Set outputs for next job
          echo "ubuntu_version=${{ github.event.inputs.ubuntu_version }}" >> $GITHUB_OUTPUT
          echo "imx_release=${{ github.event.inputs.imx_release }}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ All inputs validated successfully"

  build:
    runs-on: ubuntu-latest
    needs: validate-inputs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Free up disk space
        run: |
          echo "üìä Before cleanup:"
          df -h
          
          echo "üßπ Freeing up disk space..."
          
          # Clean apt cache
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          # Remove large directories commonly found on GitHub Actions runners
          echo "üóëÔ∏è Removing large unused components..."
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /opt/hostedtoolcache/go \
                      /opt/hostedtoolcache/CodeQL \
                      /opt/hostedtoolcache/Python \
                      /opt/hostedtoolcache/Ruby \
                      /usr/local/share/powershell \
                      /usr/local/share/chromium \
                      /usr/local/lib/node_modules 2>/dev/null || true
          
          # Remove specific packages if installed (simplified approach)
          packages_to_remove="mysql-server* postgresql* mongodb*"
          for pkg in $packages_to_remove; do
            if dpkg -l | grep -q "$pkg"; then
              echo "Removing $pkg"
              sudo apt-get purge -y $pkg 2>/dev/null || true
            fi
          done
          
          sudo apt-get autoremove -y
          sudo apt-get autoclean
          
          echo "üìä After cleanup:"
          df -h
          
      - name: Verify Docker daemon
        run: |
          echo "üê≥ Checking Docker daemon status..."
          
          # Check if Docker daemon is running
          if ! sudo systemctl is-active --quiet docker; then
            echo "Starting Docker daemon..."
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Wait for Docker to be ready
          echo "‚è≥ Waiting for Docker daemon to be ready..."
          timeout 30 bash -c 'until docker info > /dev/null 2>&1; do echo "Waiting for Docker..."; sleep 2; done'
          
          # Verify Docker is working
          echo "‚úÖ Docker status:"
          docker --version
          docker info
          sudo systemctl status docker --no-pager -l
          
      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image with standard Docker build..."
          echo "Using Dockerfile: ${{ needs.validate-inputs.outputs.ubuntu_version }}"
          echo "IMX Release: ${{ needs.validate-inputs.outputs.imx_release }}"
          
          # Set build arguments - FIXED: Use the correct argument names
          BUILD_USER="yocto"
          BUILD_UID="1000"
          BUILD_GID="1000"
          
          echo "Build arguments:"
          echo "  USER: $BUILD_USER"
          echo "  host_uid: $BUILD_UID"
          echo "  host_gid: $BUILD_GID"
          echo "  IMX_RELEASE: ${{ needs.validate-inputs.outputs.imx_release }}"
          
          # Use regular docker build with correct argument names
          if ! docker build \
            -f "${{ needs.validate-inputs.outputs.ubuntu_version }}" \
            --build-arg USER="$BUILD_USER" \
            --build-arg host_uid="$BUILD_UID" \
            --build-arg host_gid="$BUILD_GID" \
            --build-arg IMX_RELEASE="${{ needs.validate-inputs.outputs.imx_release }}" \
            --progress=plain \
            -t imx-yocto:latest .; then
            echo "‚ùå Docker build failed"
            
            # Debug information
            echo "üîç Debug information:"
            docker ps -a
            sudo systemctl status docker --no-pager -l
            
            exit 1
          fi
          
          echo "‚úÖ Docker image built successfully"
          docker images imx-yocto:latest
          
      - name: Build completion
        run: |
          echo "üéâ Build completed successfully!"
          echo "üì¶ Docker image: imx-yocto:latest"
          echo "‚è±Ô∏è Build finished at: $(date)"
